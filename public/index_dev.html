<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPARTA â€“ ETHURIUM WORLD</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- âœ… CSS ë¶„ë¦¬ -->
<link rel="stylesheet" href="/assets/styles/base.css" />
<link rel="stylesheet" href="/assets/styles/hud.css" />
<link rel="stylesheet" href="/assets/styles/orb.css" />
<link rel="stylesheet" href="/assets/styles/modal.css" />

<!-- âœ… (NEW) AI íŒì—… ì „ìš© ìŠ¤íƒ€ì¼ (ê¸°ì¡´ CSS ì•ˆ ê±´ë“œë¦¬ê³  ì¶”ê°€ë§Œ) -->
<style>
  .ai-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;

    /* ğŸ”¥ ìµœìƒìœ„ ë ˆì´ì–´ */
    z-index: 2147483647; /* max safe z-index */
  }
  .ai-backdrop[aria-hidden="false"]{ display:flex; }

  .ai-modal{
    width: min(920px, calc(100vw - 24px));
    height: min(680px, calc(100vh - 24px));
    background: rgba(10,12,18,.92);
    border: 1px solid rgba(255,255,255,.18);
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(8px);
  }

  .ai-header{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.12);
  }
  .ai-title{
    font-family: Cinzel, serif;
    font-weight: 800;
    letter-spacing: .6px;
    color: rgba(255,255,255,.92);
    font-size: 16px;
    margin: 0;
  }
  .ai-sub{
    margin-left:auto;
    color: rgba(255,255,255,.55);
    font-size: 12px;
    white-space: nowrap;
  }
  .ai-close{
    margin-left: 10px;
    width: 34px;
    height: 34px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
    cursor: pointer;
    font-weight: 900;
  }

  .ai-body{
    flex: 1;
    padding: 14px;
    overflow: auto;
  }

  .ai-msg{
    max-width: 86%;
    padding: 10px 12px;
    border-radius: 12px;
    margin: 10px 0;
    line-height: 1.35;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-word;
    border: 1px solid rgba(0,0,0,.08);
  }

  /* âœ… ì‚¬ìš©ì: í° ë°°ê²½ + ê²€ì • ê¸€ì”¨ + ë°•ìŠ¤ */
  .ai-msg.user{
    margin-left: auto;
    background: #ffffff;
    color: #111111;
  }

  /* âœ… AI: ì˜…ì€ íšŒìƒ‰ + ê²€ì • ê¸€ì”¨ + ë°•ìŠ¤ */
  .ai-msg.ai{
    margin-right: auto;
    background: #e9e9e9;
    color: #111111;
  }

  .ai-footer{
    padding: 12px 14px;
    border-top: 1px solid rgba(255,255,255,.12);
    display:flex;
    gap:10px;
    align-items:center;
  }

  .ai-input{
    flex: 1;
    height: 42px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    padding: 0 12px;
    outline: none;
    font-size: 14px;
  }
  .ai-input::placeholder{ color: rgba(255,255,255,.5); }

  .ai-send{
    height: 42px;
    padding: 0 14px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.12);
    color: rgba(255,255,255,.92);
    cursor: pointer;
    font-weight: 800;
  }
  .ai-send:disabled{
    opacity: .55;
    cursor: not-allowed;
  }
</style>
</head>

<body>
<div class="bg-layer" id="bgA"></div>
<div class="bg-layer" id="bgB"></div>
<div class="overlay"></div>

<div class="pnl-badge" id="pnlBadge">
  <span class="coin" aria-hidden="true">ğŸ’°</span>
  <span class="val" id="pnlText">-</span>
  <span class="timer" id="adenaTimer">60:00</span>
</div>

<div class="center-logo">
  <img src="/images/spartalogo.png" alt="SPARTA Logo">
  <div class="episode-title">
    <div class="ep">Episode 1</div>
    <div class="name">ë§í•˜ëŠ” ì„¬</div>
  </div>
</div>

<div class="game-title">WELCOME TO ETHURIUM WORLD (USDT)</div>

<div class="audio-ui" aria-label="BGM controls">
  <button class="icon-btn" id="bgToggleBtn" type="button" title="Screen Toggle (OFF)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="4" width="18" height="12" rx="2"></rect>
      <path d="M8 20h8"></path>
      <path d="M12 16v4"></path>
    </svg>
  </button>

  <button class="icon-btn" id="playBtn" type="button" title="Play">
    <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor">
      <path d="M8 5v14l11-7z"></path>
    </svg>
    <svg id="pauseIcon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
      <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
    </svg>
  </button>

  <button class="icon-btn" id="muteBtn" type="button" title="Unmuted">
    <svg id="volOnIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M11 5L6 9H3v6h3l5 4V5z"></path>
      <path d="M15.5 8.5a4 4 0 010 7"></path>
      <path d="M18.5 5.5a8 8 0 010 13"></path>
    </svg>
    <svg id="volOffIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
      <path d="M11 5L6 9H3v6h3l5 4V5z"></path>
      <path d="M16 8l6 8"></path>
      <path d="M22 8l-6 8"></path>
    </svg>
  </button>

  <div class="sep"></div>

  <div class="vol">
    <span style="font-weight:900;color:var(--muted);font-size:12px;">VOL</span>
    <input id="volSlider" type="range" min="0" max="100" value="25">
  </div>
</div>

<audio id="bgm" preload="auto"></audio>

<form class="toolbar" id="topForm" autocomplete="off">
  <span class="title">SPARTA HUD</span>

  <input id="priceInput" type="number" step="0.000000001"
         placeholder="ê°€ê²© ì…ë ¥ (Enterë¡œ UI ë°˜ì˜)"
         autocomplete="off" autocapitalize="off" spellcheck="false" inputmode="decimal">

  <div class="menubar" role="menubar" aria-label="Toolbar Menus">
    <div class="menu" data-menu="file">
      <button class="menu-btn" type="button" id="fileMenuBtn">File â–¾</button>
      <div class="menu-panel" role="menu">
        <button class="menu-item" type="button" id="openBtn">DB Reload (ALL tables)</button>
        <button class="menu-item" type="button" id="saveOpenedBtn">ì˜¤ëŠ˜ ê°’ DB ì €ì¥ (history upsert)</button>
        <div class="menu-sep"></div>
        <button class="menu-item" type="button" id="mobileSaveBtn">DB ì €ì¥(ë™ì¼)</button>
        <button class="menu-item" type="button" id="downloadBtn">DB ì €ì¥(ë™ì¼)</button>
      </div>
    </div>

    <div class="menu" data-menu="view">
      <button class="menu-btn" type="button">View â–¾</button>
      <div class="menu-panel" role="menu">
        <button class="menu-item" type="button" id="historyBtn">History</button>
        <button class="menu-item" type="button" id="reloadBtn">Reload (DB ALL)</button>
      </div>
    </div>

    <div class="menu" data-menu="tools">
      <button class="menu-btn" type="button">Tool â–¾</button>
      <div class="menu-panel" role="menu">
        <button class="menu-item" type="button" id="ocoBtn">OCO Quick Calc</button>
        <button class="menu-item" type="button" id="calcBtn">ê³„ì‚°ê¸°</button>
      </div>
    </div>

    <!-- âœ… Ai ë²„íŠ¼ -->
    <div class="menu" data-menu="ai">
      <button class="menu-btn" type="button" id="aiBtn">Ai</button>
    </div>
  </div>

  <div class="toolbar-center">
    <div class="countdown-hud" aria-label="Countdown HUD">
      <div class="label" id="countdownLabel">COUNTDOWN TO 2026-06-30</div>
      <div class="time" id="countdownText">-</div>
    </div>
  </div>

  <span class="badge" id="priceBadge">Current: -</span>
  <span class="badge" id="fileStatus">DB: (ë¯¸ì—°ê²°)</span>
</form>

<div class="quota-ticker" id="quotaTicker" aria-hidden="true">
  <div class="track" id="quotaTrack">
    <span class="msg">[Spartaêµ°ì£¼] ë‹˜, ì˜¤ëŠ˜ì˜ ëª©í¬ë¥¼ ë‹¬ì„± í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ì œ ì°¨íŠ¸ë¥¼ ë‹«ê³  íœ´ì‹ì„ ê¶Œê³ í•©ë‹ˆë‹¤!</span>
    <span class="gap"></span>
    <span class="msg">[Spartaêµ°ì£¼] ë‹˜, ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ë‹¬ì„± í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ì œ ì°¨íŠ¸ë¥¼ ë‹«ê³  íœ´ì‹ì„ ê¶Œê³ í•©ë‹ˆë‹¤!</span>
    <span class="gap"></span>
  </div>
</div>

<div class="orb orb-left hidden" id="leftOrb" aria-label="Left Crystal Orb">
  <div class="fill fill-green" id="leftFill">
    <svg class="water-fx" viewBox="0 0 300 120" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="shineGradL" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="rgba(255,255,255,0.00)"/>
          <stop offset="0.45" stop-color="rgba(255,255,255,0.28)"/>
          <stop offset="0.55" stop-color="rgba(255,255,255,0.14)"/>
          <stop offset="1" stop-color="rgba(255,255,255,0.00)"/>
        </linearGradient>
      </defs>
      <path class="water-line" d="" />
      <path class="water-shine" d="" fill="url(#shineGradL)" />
    </svg>
  </div>
  <div class="glass"></div>
  <div class="ring"></div>
  <div class="label" id="leftLabel">-</div>
</div>

<div class="orb orb-right hidden" id="rightOrb" aria-label="Right Crystal Orb">
  <div class="fill fill-blue" id="rightFill">
    <svg class="water-fx" viewBox="0 0 300 120" preserveAspectRatio="none" aria-hidden="true">
      <defs>
        <linearGradient id="shineGradR" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="rgba(255,255,255,0.00)"/>
          <stop offset="0.45" stop-color="rgba(255,255,255,0.28)"/>
          <stop offset="0.55" stop-color="rgba(255,255,255,0.14)"/>
          <stop offset="1" stop-color="rgba(255,255,255,0.00)"/>
        </linearGradient>
      </defs>
      <path class="water-line" d="" />
      <path class="water-shine" d="" fill="url(#shineGradR)" />
    </svg>
  </div>
  <div class="glass"></div>
  <div class="ring"></div>
  <div class="label" id="rightLabel">-</div>
</div>

<!-- ê¸°ì¡´ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modalRoot" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <h2 id="modalTitle">-</h2>
      <span class="hint" id="modalHint"></span>
      <button class="x" type="button" id="modalClose">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- âœ… (NEW) AI íŒì—… -->
<div class="ai-backdrop" id="aiBackdrop" aria-hidden="true">
  <div class="ai-modal" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
    <div class="ai-header">
      <h2 class="ai-title" id="aiTitle">AI CHAT</h2>
      <div class="ai-sub" id="aiStatus">ready</div>
      <button class="ai-close" type="button" id="aiCloseBtn">âœ•</button>
    </div>

    <div class="ai-body" id="aiChatBody" aria-label="AI conversation"></div>

    <div class="ai-footer">
      <input class="ai-input" id="aiInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" />
      <button class="ai-send" id="aiSendBtn" type="button">Send</button>
    </div>
  </div>
</div>

<div class="bottom-console" aria-label="Command console">
  <textarea id="consoleLog" class="console-log" readonly
    placeholder="ëª…ë ¹ì–´ ê²°ê³¼ê°€ ì—¬ê¸°ì— ëˆ„ì ë©ë‹ˆë‹¤."></textarea>
  <input id="consoleCmd" class="console-cmd" type="text"
    placeholder="ëª…ë ¹ì–´ ì…ë ¥ (ì˜ˆ: /ëˆ„êµ¬, /ì‹œê°„, /ê²½í—˜ì¹˜, /ì±„íŒ… ë”, /ì±„íŒ… ì¼¬, /ì˜¤ë¸Œ ë”, /ì˜¤ë¸Œ ì¼¬, /í™”ë©´ ë”, /í™”ë©´ ì¼¬, /ìŒì•… ë”, /ìŒì•… ì¼¬, /ê·¸ë˜í”„, /ê³„ì‚°ê¸°, /oco, /ë¦¬ë¡œë“œ)">
</div>

<div class="bottom-indicator" aria-label="Current indicator">
  <div class="wrap">
    <div class="bar"><div class="fill" id="bottomFill"></div></div>
    <div class="value" id="bottomValue">- / 50000</div>
  </div>
</div>

<!-- âœ… JS ë¶„ë¦¬ -->
<script type="module" src="/src/main.js"></script>

<!-- âœ… (NEW) AI íŒì—… ë¡œì§ -->
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const aiBtn = document.getElementById("aiBtn");
    const aiBackdrop = document.getElementById("aiBackdrop");
    const aiCloseBtn = document.getElementById("aiCloseBtn");
    const aiChatBody = document.getElementById("aiChatBody");
    const aiInput = document.getElementById("aiInput");
    const aiSendBtn = document.getElementById("aiSendBtn");
    const aiStatus = document.getElementById("aiStatus");

    // âœ… Ollama/FastAPI(ë˜ëŠ” ë„¤ê°€ ë§Œë“  LLM ì„œë²„) ì—”ë“œí¬ì¸íŠ¸
    // main.jsì—ì„œë„ ì“°ë˜ ê·¸ ê°’ìœ¼ë¡œ ë§ì¶¤
    const LLM_ENDPOINT = "http://127.0.0.1:8000/chat";
    const LLM_MAX_TURNS = 20;

    // AI ëŒ€í™” íˆìŠ¤í† ë¦¬(íŒì—… ì „ìš©)
    const aiMessages = [
      { role: "system", content: "You are a helpful assistant. Answer in Korean, concise." },
    ];

    function trimHistory() {
      const keep = 1 + LLM_MAX_TURNS * 2;
      if (aiMessages.length > keep) aiMessages.splice(1, aiMessages.length - keep);
    }

    function openAiPopup() {
      aiBackdrop.setAttribute("aria-hidden", "false");
      // ì²« ì˜¤í”ˆ ì‹œ í¬ì»¤ìŠ¤
      setTimeout(() => { try { aiInput.focus(); } catch {} }, 0);
    }

    function closeAiPopup() {
      aiBackdrop.setAttribute("aria-hidden", "true");
    }

    function addBubble(kind, text) {
      const div = document.createElement("div");
      div.className = "ai-msg " + (kind === "user" ? "user" : "ai");
      div.textContent = String(text ?? "");
      aiChatBody.appendChild(div);
      aiChatBody.scrollTop = aiChatBody.scrollHeight;
    }

    async function sendToAi(userText) {
      const msg = String(userText || "").trim();
      if (!msg) return;

      // ë‚´ ë§
      addBubble("user", msg);

      aiMessages.push({ role: "user", content: msg });
      trimHistory();

      aiStatus.textContent = "thinking...";
      aiSendBtn.disabled = true;
      aiInput.disabled = true;

      try {
        const res = await fetch(LLM_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: aiMessages }),
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        const content = String(data?.content ?? "").trim();
        if (!content) throw new Error("ë¹ˆ ì‘ë‹µ");

        aiMessages.push({ role: "assistant", content });
        trimHistory();

        // AI ë‹µ
        addBubble("ai", content);
        aiStatus.textContent = "ready";
      } catch (e) {
        addBubble("ai", "ì—°ê²° ì˜¤ë¥˜: AI ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”. (" + (e?.message ?? e) + ")");
        aiStatus.textContent = "error";
      } finally {
        aiSendBtn.disabled = false;
        aiInput.disabled = false;
        try { aiInput.focus(); } catch {}
      }
    }

    // ë²„íŠ¼ ë°”ì¸ë”©
    aiBtn?.addEventListener("click", openAiPopup);
    aiCloseBtn?.addEventListener("click", closeAiPopup);

    // ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«ê¸°(ëª¨ë‹¬ ë°– í´ë¦­)
    aiBackdrop?.addEventListener("click", (e) => {
      if (e.target === aiBackdrop) closeAiPopup();
    });

    // ESCë¡œ ë‹«ê¸°
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && aiBackdrop.getAttribute("aria-hidden") === "false") {
        closeAiPopup();
      }
    });

    // ì „ì†¡
    aiSendBtn?.addEventListener("click", () => {
      const text = aiInput.value;
      aiInput.value = "";
      sendToAi(text);
    });

    aiInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const text = aiInput.value;
        aiInput.value = "";
        sendToAi(text);
      }
    });

    // ì²« ì•ˆë‚´(ì›í•˜ë©´ ì‚­ì œ)
    addBubble("ai", "AI ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ. ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
  });
</script>

</body>
</html>